<link rel="stylesheet" href="leaflet/leaflet.css">

<script src="leaflet/leaflet.js"></script>

<polymer-element name="leaflet-map"
  attributes="width height zoom lat lng tiles items panelTitle">
  <template>
    <style>:host { display: block; }</style>
    <figure class="panel panel-default">
      <h2 class="panel-heading" template if="{{ panelTitle }}">{{ panelTitle }}</h2>

      <div id="map"></div>

      <figcaption class="panel-body">
        <content select="p"></content>
      </figcaption>
    </figure>
  </template>

  <script>
  Polymer('leaflet-map', {
    panelTitle: '',
    width: '100%',
    height: '500px',
    zoom: 10,
    lat: 51.5,
    lng: 0,
    tiles: 'http://{s}.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg',
    added: {},
    ready: function() {
      this.items = this.items || [];
      this.added = {};

      ['width', 'height'].forEach(function(property) {
        this.$.map.style[property] = this[property];
      }.bind(this));

      this.map = L.map(this.$.map).setView([this.lat, this.lng], this.zoom);

      L.tileLayer(this.tiles).addTo(this.map);

      // make the map draw full size
      window.dispatchEvent(new Event('resize'));
    },
    itemsChanged: function() {
      this.items.filter(function(item) {
        return item.geolocation && !this.added[item._id];
      }.bind(this)).forEach(function(item) {
        this.added[item._id] = L.marker([item.geolocation.lat, item.geolocation.lng])
          .addTo(this.map)
          .bindPopup('<strong>' + item.name + '</strong><br>' + item.location); // FIXME: build an element
      }.bind(this));
    }
  });
  </script>
</element>